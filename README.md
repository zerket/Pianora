# Pianora

Подсветка клавиш цифрового пианино с помощью адресной LED-ленты.

## Структура проекта

```
piano-led/
├── firmware/              # Прошивка ESP32-S3 (PlatformIO)
│   ├── src/               # Исходный код
│   │   ├── main.cpp
│   │   ├── led_controller.cpp
│   │   ├── midi_handler.cpp
│   │   ├── wifi_manager.cpp
│   │   ├── web_server.cpp
│   │   └── settings_manager.cpp
│   ├── include/           # Заголовочные файлы
│   ├── data/              # Файлы для LittleFS (веб-интерфейс)
│   └── platformio.ini     # Конфигурация PlatformIO
│
├── app/                   # PWA приложение (Angular)
│   ├── src/
│   │   ├── app/
│   │   │   ├── core/      # Сервисы, модели
│   │   │   ├── shared/    # Общие компоненты
│   │   │   └── features/  # Основные страницы
│   │   │       ├── play/
│   │   │       ├── learn/
│   │   │       ├── library/
│   │   │       └── settings/
│   │   └── environments/
│   ├── package.json
│   └── angular.json
│
├── README.md              # Описание проекта
└── SPECIFICATION.md       # Техническое задание
```

## Быстрый старт

### Прошивка (firmware)

```bash
cd firmware

# Установка PlatformIO CLI (если не установлен)
pip install platformio

# Сборка
pio run

# Загрузка на ESP32
pio run --target upload

# Загрузка файловой системы
pio run --target uploadfs
```

### Приложение (app)

```bash
cd app

# Установка зависимостей
npm install

# Запуск dev-сервера
npm start

# Сборка для production
npm run build:prod
```

### Тестирование PWA без железа

Приложение имеет встроенный **Mock режим** для тестирования без ESP32:

1. В файле `app/src/environments/environment.ts` установлено `useMock: true`
2. Запустите `npm start`
3. Откройте `http://localhost:4200`
4. В правом нижнем углу появится кнопка 🎮 (Debug Panel)

**Debug Panel позволяет:**
- Симулировать нажатия клавиш
- Проигрывать аккорды и гаммы
- Запускать автоматическую симуляцию
- Переключать статусы MIDI и калибровки
- Тестировать мини-пианино

Для переключения на реальное железо установите `useMock: false`.

## Описание проекта

Система подсветки клавиш цифрового пианино на базе ESP32-S3 с управлением через мобильное/веб приложение.

### Основные функции

- **Визуализация** — подсветка нажатых клавиш в реальном времени
- **Обучение** — режим обучения с подсказками
- **Кастомизация** — настройка цветов, эффектов, яркости
- **Беспроводное управление** — WiFi/Bluetooth для связи с приложением

## Аппаратная часть

### Компоненты

| Компонент | Описание | Цена |
|-----------|----------|------|
| ESP32-S3-WROOM-1-N16R8 | Контроллер с WiFi + BT + USB Host | $10-15 |
| WS2812B 144 LED/m | Адресная LED-лента (для 88 клавиш) | — |
| Блок питания 5V 10A | Питание ленты и контроллера (с запасом 20%) | $10-20 |
| Конденсатор 1000µF 10V | Защита от скачков напряжения | $0.5 |
| Резистор 330-470 Ом | На линию данных ленты | $0.1 |
| USB OTG кабель/адаптер | Подключение пианино | $2 |
| Провод 1.5 мм² (AWG 16) | Питание ленты | $3-5 |

### Схема подключения

```
                    ┌──────────────────┐
                    │   ESP32-S3       │
   ┌────────┐       │                  │       ┌─────────────┐
   │ Пианино│──USB──│ USB (Host)       │       │  WS2812B    │
   │        │       │                  │       │  144 LED    │
   └────────┘       │ GPIO ────────────│───────│ DIN         │
                    │                  │       │             │
                    │ WiFi/BT          │       └─────────────┘
                    │     ↕            │              │
                    └──────────────────┘              │
                           │                         │
                    ┌──────┴─────────────────────────┤
                    │         БП 5V 10A              │
                    │    (общее питание)             │
                    └────────────────────────────────┘
```

### Подключение MIDI

Два варианта получения MIDI данных:

1. **USB MIDI (основной)** — ESP32-S3 в режиме USB Host принимает MIDI напрямую
2. **Bluetooth MIDI (опционально)** — беспроводное подключение через BLE MIDI

## Программная часть

### Прошивка ESP32-S3

- Приём MIDI событий (USB Host / BLE MIDI)
- Управление WS2812B лентой
- WiFi AP / Station режимы
- HTTP сервер (раздача PWA)
- WebSocket сервер (realtime связь)
- Файловая система LittleFS (настройки, уроки, записи)
- OTA обновления

### Веб-приложение (PWA на Angular)

- Настройка цветов и эффектов
- Режим обучения
- Визуализация игры
- Библиотека композиций
- Настройки контроллера

## Архитектура

### Контроллер ESP32-S3

```
┌─────────────────────────────────────────────────────────┐
│                      ESP32-S3                           │
├─────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐  │
│  │ Web Server  │  │  WebSocket  │  │   File System   │  │
│  │ (PWA files) │  │  (realtime) │  │   (LittleFS)    │  │
│  └─────────────┘  └─────────────┘  └─────────────────┘  │
│                                                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐  │
│  │ WiFi AP/STA │  │  USB MIDI   │  │   LED Driver    │  │
│  └─────────────┘  └─────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

### Сетевые режимы

**AP Mode (по умолчанию):**
- ESP32 создаёт сеть "Pianora"
- Телефон подключается напрямую
- Адрес: http://192.168.4.1

**Station Mode (опционально):**
- ESP32 подключается к домашнему WiFi
- Все устройства в одной сети
- mDNS: http://pianora.local

### Настройки контроллера

**Сетевые:**
- Режим работы (AP / Station)
- Credentials домашней сети
- Имя и пароль точки доступа
- mDNS имя

**Хранилище:**
- Просмотр файлов (уроки, записи, настройки)
- Загрузка / удаление файлов
- Информация о свободном месте

**LED:**
- Яркость по умолчанию
- Количество LED
- Направление ленты
- Калибровка (маппинг LED → ноты)

**Система:**
- Версия прошивки
- OTA обновление
- Сброс к заводским настройкам
- Перезагрузка

## Протокол связи

Основной транспорт: **WebSocket** (работает на всех платформах)

TODO: Описать формат сообщений

## План разработки

### Этап 1: Прототип железа
- [x] Заказать компоненты
- [ ] Собрать макет на breadboard
- [ ] Проверить USB Host MIDI
- [ ] Проверить управление лентой

### Этап 2: Базовая прошивка
- [x] Структура проекта PlatformIO
- [x] LED контроллер (FastLED)
- [x] MIDI Handler
- [x] WiFi Manager (AP/Station)
- [x] WebSocket сервер
- [ ] Тестирование на железе

### Этап 3: Приложение
- [x] Структура Angular PWA
- [x] Базовый UI (4 экрана)
- [x] WebSocket связь
- [x] Mock режим для тестирования
- [x] Debug Panel
- [ ] Доработка UI

### Этап 4: Обучение
- [ ] Формат хранения композиций
- [ ] Режим обучения с подсказками
- [ ] Нотный стан (VexFlow)
- [ ] Статистика прогресса

### Этап 5: Финализация
- [ ] Корпус
- [ ] Документация
- [ ] Стабилизация

## Технические заметки

### Потребление тока WS2812B

- 1 LED при полной яркости белого: ~60mA
- 144 LED максимум: ~8.6A
- Реалистичный сценарий (ограниченная яркость): 2-3A

### Питание ленты

Длина ленты ~123 см — рекомендуется подавать питание с двух сторон для равномерной яркости:

```
    +5V ────────────────────────────────────── +5V
         │                                    │
    ┌────┴────────────────────────────────────┴────┐
    │    ● ● ● ● ● ● ● ● ● ● ● ● ● ● ● ● ● ● ●    │
    └────┬────────────────────────────────────┬────┘
         │               │                    │
    GND ─┴───────────────│────────────────────┴─ GND
                         │
                    DIN (от ESP32)
```

### Пины ESP32-S3

- GPIO19/20 — USB D-/D+ (USB Host)
- GPIO48 (или другой RMT-совместимый) — данные WS2812B
