<p align="center">
  <img src="docs/images/logo.png" alt="Pianora Logo" width="200"/>
</p>

<h1 align="center">Pianora</h1>

<p align="center">
  <strong>Система LED-визуализации для цифровых пианино</strong><br>
  Превратите игру на пианино в красочное световое шоу
</p>

<p align="center">
  <a href="#возможности">Возможности</a> •
  <a href="#демо">Демо</a> •
  <a href="#железо">Железо</a> •
  <a href="#установка">Установка</a> •
  <a href="#использование">Использование</a> •
  <a href="#участие">Участие</a>
</p>

<p align="center">
  <img src="https://img.shields.io/badge/версия-0.2.0-blue.svg" alt="Версия">
  <img src="https://img.shields.io/badge/платформа-ESP32--S3-orange.svg" alt="Платформа">
  <img src="https://img.shields.io/badge/лицензия-MIT-green.svg" alt="Лицензия">
  <img src="https://img.shields.io/badge/PRs-welcome-brightgreen.svg" alt="PRs Welcome">
</p>

---

## Что такое Pianora?

Pianora — это open-source система LED-визуализации, которая подсвечивает клавиши вашего цифрового пианино в реальном времени. Подключите MIDI-клавиатуру к микроконтроллеру ESP32-S3, закрепите светодиодную ленту WS2812B над клавишами и наслаждайтесь тем, как ваша музыка оживает в красках света.

**Идеально подходит для:**
- Обучения игре на пианино с визуальной обратной связью
- Создания эффектных видео фортепианных выступлений
- Атмосферной подсветки музыкальной комнаты
- Преподавания фортепиано ученикам

## Возможности

### Режимы LED

| Режим | Описание |
|-------|----------|
| **Свободная игра** | Простая подсветка клавиш — нажал клавишу, загорелся LED |
| **Визуализатор** | Красивые эффекты: затухание, волны, градиенты |
| **Разделение** | Двухцветное разделение клавиатуры для разных рук |
| **Динамика** | Цвет меняется в зависимости от силы нажатия |
| **Случайный** | Каждая клавиша получает уникальный случайный цвет |
| **Фоновая** | Декоративные эффекты: радуга, пульсация, дыхание, волна |
| **Обучение** | Визуальные подсказки для разучивания композиций |
| **Демо** | Автоматическое воспроизведение композиций |

### Источники MIDI

| Источник | Описание |
|----------|----------|
| **USB MIDI** | Прямое подключение через USB Host ESP32-S3 |
| **Bluetooth MIDI** | Беспроводное BLE MIDI подключение |
| **WiFi MIDI** | rtpMIDI/AppleMIDI для сетевого подключения |

### Дополнительные возможности

- **PWA-приложение** — управляйте всем с телефона
- **OTA-обновления** — обновление прошивки по воздуху через ElegantOTA
- **Мультиязычность** — поддержка EN, RU, DE, ES, FR
- **Быстрая калибровка** — настройка соответствия LED и клавиш за секунды
- **Mock-режим** — тестирование приложения без железа

## Демо

<!-- TODO: Добавить демо-видео/GIF -->
*Демо-видео скоро появится!*

## Железо

### Список компонентов

| Компонент | Описание | Примерная цена |
|-----------|----------|----------------|
| **ESP32-S3-WROOM-1-N16R8** | Основной контроллер с WiFi, BT, USB Host | $10-15 |
| **WS2812B LED лента** | 144 LED/м, 5V (для 88 клавиш нужно ~1.2м) | $15-25 |
| **Блок питания 5V 10A** | Питание LED и контроллера | $10-20 |
| **Конденсатор 1000µF 10V** | Защита от скачков напряжения | $0.50 |
| **Резистор 330-470 Ом** | Защита линии данных | $0.10 |
| **USB OTG кабель/адаптер** | Подключение пианино к ESP32 | $2-5 |
| **Провода (AWG 16)** | Разводка питания | $3-5 |

**Общая примерная стоимость: $40-70** (без учёта пианино)

### Схема подключения

```
                    ┌──────────────────┐
                    │   ESP32-S3       │
   ┌────────┐       │                  │       ┌─────────────┐
   │Пианино │──USB──│ GPIO19/20 (USB)  │       │  WS2812B    │
   │ (MIDI) │       │                  │       │  LED лента  │
   └────────┘       │ GPIO48 ──────────│───────│ DIN         │
                    │                  │       │             │
                    │ WiFi / BT        │       └─────────────┘
                    └──────────────────┘              │
                           │                         │
                    ┌──────┴─────────────────────────┤
                    │      Блок питания 5V 10A       │
                    │      (общая земля)             │
                    └────────────────────────────────┘
```

### Расчёт питания

- 1 LED на максимальной белой яркости: ~60мА
- 144 LED теоретический максимум: ~8.6А
- Реальное использование (ограниченная яркость): 2-3А
- **Рекомендация**: используйте БП 5V 10A с запасом 20%

Для лент длиннее 1м подводите питание с обоих концов:

```
    +5V ─────────────────────────────────────── +5V
         │                                    │
    ┌────┴────────────────────────────────────┴────┐
    │    ● ● ● ● ● ● ● ● ● ● ● ● ● ● ● ● ● ● ●    │
    └────┬────────────────────────────────────┬────┘
         │               │                    │
    GND ─┴───────────────│────────────────────┴─ GND
                         │
                    DIN (от ESP32)
```

## Установка

### Требования

- [PlatformIO](https://platformio.org/) (для прошивки)
- [Node.js 18+](https://nodejs.org/) (для PWA-приложения)
- USB-кабель для первоначальной загрузки прошивки

### Установка прошивки

```bash
# Клонируйте репозиторий
git clone https://github.com/yourusername/Pianora.git
cd Pianora/firmware

# Соберите и загрузите прошивку
pio run -e esp32-s3 --target upload

# Загрузите веб-интерфейс в файловую систему
pio run -e esp32-s3 --target uploadfs
```

**Альтернативные сборки:**

```bash
# Минимальная версия (урезанный функционал, 4MB flash)
pio run -e esp32-s3-barebones --target upload

# Обычный ESP32 (не S3, без USB MIDI)
pio run -e esp32 --target upload
```

### Разработка PWA-приложения

```bash
cd app

# Установите зависимости
npm install

# Запустите сервер разработки (с mock-режимом)
npm start

# Сборка для продакшена
npm run build:prod
```

## Использование

### Первый запуск

1. **Включите питание** ESP32 — на ленте появится радужная анимация
2. **Подключитесь к WiFi** "Pianora" (пароль: `pianora123`)
3. **Откройте браузер** по адресу `http://192.168.4.1`
4. **Запустите калибровку** — нажмите крайнюю левую и правую клавиши пианино
5. **Играйте!**

### Сетевые режимы

| Режим | Описание | Адрес |
|-------|----------|-------|
| **Режим AP** (по умолчанию) | ESP32 создаёт свою сеть | `http://192.168.4.1` |
| **Режим Station** | ESP32 подключается к вашему WiFi | `http://pianora.local` |

### OTA-обновления

При включённом ElegantOTA обновляйте прошивку по воздуху:
1. Откройте `http://pianora.local/update` (или `http://192.168.4.1/update`)
2. Загрузите новый бинарный файл прошивки
3. Устройство перезагрузится автоматически

### Тестирование без железа

Приложение включает **Mock-режим** для разработки и тестирования:

1. Установите `useMock: true` в `app/src/environments/environment.ts`
2. Запустите `npm start`
3. Откройте `http://localhost:4200`
4. Нажмите кнопку геймпада (внизу справа) для открытия панели отладки

**Возможности панели отладки:**
- Симуляция нажатий клавиш
- Воспроизведение аккордов и гамм
- Переключение статуса MIDI/калибровки
- Мини-клавиатура пианино

## Структура проекта

```
Pianora/
├── firmware/                 # Прошивка ESP32-S3 (PlatformIO)
│   ├── src/
│   │   ├── main.cpp          # Точка входа
│   │   ├── led_controller.cpp # Режимы и эффекты LED
│   │   ├── midi_handler.cpp  # Обработка USB MIDI
│   │   ├── ble_midi.cpp      # Bluetooth MIDI
│   │   ├── rtp_midi.cpp      # WiFi MIDI (AppleMIDI)
│   │   ├── web_server.cpp    # HTTP + WebSocket сервер
│   │   ├── wifi_manager.cpp  # WiFi AP/Station
│   │   └── settings_manager.cpp
│   ├── include/              # Заголовочные файлы
│   └── platformio.ini        # Конфигурация сборки
│
├── app/                      # Angular PWA
│   ├── src/app/
│   │   ├── core/             # Сервисы, модели, i18n
│   │   ├── shared/           # Переиспользуемые компоненты
│   │   └── features/         # Основные экраны
│   │       ├── play/         # Выбор режима
│   │       ├── learn/        # Режим обучения
│   │       ├── library/      # Библиотека композиций
│   │       └── settings/     # Настройки
│   └── package.json
│
├── docs/                     # Документация
├── README.md                 # Этот файл
└── SPECIFICATION.md          # Техническое задание
```

## Конфигурация

### Флаги компиляции (firmware/include/config.h)

```cpp
#define USE_ELEGANT_OTA     1   // OTA-обновления (отключите для экономии места)
#define USE_BLE_MIDI        1   // Поддержка Bluetooth MIDI
#define USE_RTP_MIDI        1   // Поддержка WiFi MIDI
```

### Основные параметры

| Параметр | По умолчанию | Описание |
|----------|--------------|----------|
| `LED_PIN` | GPIO48 | Пин данных для WS2812B |
| `LED_COUNT` | 144 | Количество LED |
| `WIFI_AP_SSID` | "Pianora" | Имя точки доступа |
| `WIFI_AP_PASSWORD` | "pianora123" | Пароль точки доступа |
| `MDNS_HOSTNAME` | "pianora" | mDNS-имя (pianora.local) |

## API

### Протокол WebSocket

Сообщения используют JSON-формат:

```json
{
  "type": "тип_сообщения",
  "payload": { ... }
}
```

**От контроллера:**
- `status` — обновление статуса контроллера
- `midi_note` — события note on/off
- `calibration_step` — прогресс калибровки

**От приложения:**
- `set_mode` — смена режима LED
- `set_settings` — обновление настроек
- `start_calibration` — начало калибровки
- `scan_ble_midi` — поиск BLE-устройств

Полная документация протокола в [SPECIFICATION.md](SPECIFICATION.md).

## Дорожная карта

### Готово

- [x] Базовые режимы LED (Свободная игра, Визуализатор, Фоновая)
- [x] Поддержка USB MIDI
- [x] Поддержка Bluetooth MIDI
- [x] WiFi MIDI (rtpMIDI)
- [x] Режимы Split, Velocity, Random
- [x] PWA с mock-режимом
- [x] OTA-обновления
- [x] Мультиязычность
- [x] Быстрая калибровка

### В процессе

- [ ] Режим обучения с воспроизведением композиций
- [ ] Библиотека композиций с импортом MIDI
- [ ] Отображение нот (VexFlow)
- [ ] Запись и воспроизведение

### Планы

- [ ] Игровой режим (в стиле Guitar Hero)
- [ ] Интеграция с Synthesia
- [ ] Визуализация падающих нот
- [ ] Облачная синхронизация
- [ ] Статистика и отслеживание прогресса

## Участие

Будем рады вашему участию! Не стесняйтесь создавать Pull Request.

1. Сделайте форк репозитория
2. Создайте ветку для функции (`git checkout -b feature/АхренительнаяФича`)
3. Сделайте коммит изменений (`git commit -m 'Добавить АхренительнуюФичу'`)
4. Запушьте ветку (`git push origin feature/АхренительнаяФича`)
5. Откройте Pull Request

## Благодарности

Этот проект был вдохновлён:
- [Piano-LED-Visualizer](https://github.com/onlaj/Piano-LED-Visualizer) — решение на Raspberry Pi
- [PianoLux-ESP32](https://github.com/serifpersia/pianolux-esp32) — реализация на ESP32

## Лицензия

Проект распространяется под лицензией MIT — см. файл [LICENSE](LICENSE) для подробностей.

---

<p align="center">
  Сделано с музыкой и кодом<br>
  <a href="https://github.com/yourusername/Pianora">Поставьте звезду</a>, если проект оказался полезен!
</p>
