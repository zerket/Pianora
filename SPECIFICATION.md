# Pianora: Техническое задание

## 1. Инициализация и подключение

### 1.1 Запуск контроллера

При включении питания:

1. **Индикация загрузки** — разноцветная волна по ленте (туда-обратно, один раз)
2. Контроллер поднимает WiFi (AP или Station в зависимости от настроек)
3. Ожидание подключения MIDI-устройства (USB)

### 1.2 Источники MIDI

Контроллер поддерживает три источника MIDI-сигнала:

| Источник | Описание | Требования |
|----------|----------|------------|
| **USB MIDI** | Прямое подключение пианино к ESP32-S3 | ESP32-S3 с USB Host |
| **Bluetooth MIDI** | Беспроводное BLE MIDI подключение | ESP32 с BLE |
| **WiFi MIDI (rtpMIDI)** | Сетевое MIDI через AppleMIDI/rtpMIDI | WiFi соединение |

**USB MIDI:**
- Подключение через GPIO19/20 (USB D-/D+)
- Поддержка USB Host режима
- Автоматическое определение устройства

**Bluetooth MIDI:**
- BLE MIDI профиль
- Сканирование и подключение к устройствам
- Имя устройства: "Pianora-BLE"

**WiFi MIDI (rtpMIDI):**
- Совместимость с Apple MIDI Network
- Порт: 5004
- Автоматическая регистрация через mDNS

### 1.3 Индикация состояния

| Состояние                             | Индикация на ленте                          |
| ---------------------------------------------- | ----------------------------------------------------------- |
| Загрузка                               | Разноцветная волна туда-обратно |
| WiFi AP готов                             | Короткая синяя вспышка                  |
| WiFi подключён к сети            | Короткая зелёная вспышка              |
| USB MIDI подключено | Короткая белая вспышка                  |
| BLE MIDI подключено | Короткая голубая вспышка |
| rtpMIDI активен | Короткая фиолетовая вспышка |
| Ошибка                                   | Красная вспышка                               |

### 1.4 Первый запуск — обязательная калибровка

При первом включении (или после сброса) контроллер требует калибровку:

**Процесс калибровки:**

1. Приложение показывает инструкцию
2. Загорается первый LED на ленте
3. Пользователь нажимает клавишу, напротив которой находится этот LED
4. Контроллер запоминает соответствие MIDI-нота → LED индекс
5. Загорается следующий LED
6. Повторяется для крайних клавиш (первая и последняя)
7. Промежуточные значения интерполируются автоматически

**Быстрая калибровка (при первом запуске):**

1. Пользователь нажимает самую левую клавишу пианино
2. Пользователь нажимает самую правую клавишу пианино
3. Система автоматически распределяет LED между ними (интерполяция)

**Точная калибровка (по желанию пользователя):**

- Доступна в настройках приложения
- Пошаговый проход по каждому LED
- Позволяет скорректировать неточности быстрой калибровки

### 1.5 Горячие клавиши на пианино

Одновременное нажатие двух определённых клавиш вызывает функцию:

| Комбинация | Действие                                                                     |
| -------------------- | ------------------------------------------------------------------------------------ |
| TODO                 | Переключение режима                                                |
| TODO                 | Включить/выключить подсветку                               |
| TODO                 | Увеличить яркость                                                    |
| TODO                 | Уменьшить яркость                                                    |
| TODO                 | Запуск/пауза воспроизведения (режим обучения) |

*Конкретные комбинации определим после реализации базового функционала*

---

## 2. Режимы работы

### 2.1 Режим визуализации (Visualizer)

**Описание:** Лента реагирует на нажатия клавиш в реальном времени.

**Поведение:**

- При нажатии клавиши — загорается соответствующий LED
- При отпускании — LED плавно гаснет (или сразу, в зависимости от настроек)
- Опционально: эффект волны от нажатой клавиши

**Настройки в приложении:**

| Параметр                           | Тип            | Описание                                                         |
| ------------------------------------------ | ----------------- | ------------------------------------------------------------------------ |
| Цвет                                   | Color picker      | Основной цвет подсветки                             |
| Яркость                             | Slider 0-100%     | Яркость LED                                                       |
| Время затухания              | Slider 0-2 сек | Как быстро гаснет LED после отпускания     |
| Эффект волны                    | Toggle            | Включить/выключить волну                           |
| Ширина волны                    | Slider 1-10 LED   | Сколько соседних LED захватывает волна    |
| Скорость волны                | Slider            | Скорость распространения волны               |
| Цвет волны                        | Color picker      | Цвет эффекта волны                                       |
| Градиент по клавиатуре | Toggle            | Цвет меняется от низких к высоким нотам |

---

### 2.2 Режим обучения (Learning)

**Описание:** Приложение показывает какие клавиши нужно нажать, пользователь следует подсказкам.

**Поведение:**

- LED подсвечивает клавиши, которые нужно нажать
- При правильном нажатии — LED меняет цвет (подтверждение)
- При неправильном нажатии — индикация ошибки
- Переход к следующей ноте/аккорду после правильного нажатия

**Подрежимы:**

| Подрежим           | Описание                                                                                                                          |
| -------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------- |
| Ожидание           | Ждёт пока пользователь нажмёт правильные клавиши, без ограничения времени |
| Ритм                   | Клавиши нужно нажимать в правильном ритме                                                             |
| Автопрокрутка | Подсветка движется независимо от нажатий (для просмотра)                                  |

**Настройки в приложении:**

| Параметр                                 | Тип       | Описание                                                                         |
| ------------------------------------------------ | ------------ | ---------------------------------------------------------------------------------------- |
| Цвет подсказки                      | Color picker | Цвет LED для клавиш, которые нужно нажать                 |
| Цвет успеха                            | Color picker | Цвет при правильном нажатии                                      |
| Цвет ошибки                            | Color picker | Цвет при неправильном нажатии                                  |
| Темп                                         | Slider BPM   | Скорость воспроизведения                                          |
| Показывать следующие ноты | Slider 0-5   | Сколько нот вперёд подсвечивать (полупрозрачно) |
| Разделение рук                      | Toggle       | Разные цвета для левой и правой руки                       |

---

### 2.3 Режим свободной игры (Free Play)

**Описание:** Простой режим без эффектов — просто подсветка нажатых клавиш.

**Поведение:**

- Нажал клавишу — LED горит
- Отпустил — LED погас
- Минимальная задержка, максимальная отзывчивость

**Настройки:**

| Параметр | Тип       | Описание            |
| ---------------- | ------------ | --------------------------- |
| Цвет         | Color picker | Цвет подсветки |
| Яркость   | Slider       | Яркость              |

---

### 2.4 Режим демонстрации (Demo)

**Описание:** Автоматическое воспроизведение композиции на ленте без участия пользователя.

**Применение:**

- Просмотр как должна звучать/выглядеть композиция
- Демонстрация возможностей системы
- Фоновая подсветка

**Настройки:**

| Параметр            | Тип | Описание                                |
| --------------------------- | ------ | ----------------------------------------------- |
| Композиция        | Select | Выбор из библиотеки            |
| Темп                    | Slider | Скорость воспроизведения |
| Цветовая схема | Select | Пресет цветов                       |
| Зациклить          | Toggle | Повторять по кругу              |

---

### 2.5 Режим записи (Recording)

**Описание:** Запись игры пользователя для последующего воспроизведения или анализа.

**Поведение:**

- Пользователь нажимает "Запись" в приложении
- Играет на пианино
- Все MIDI-события сохраняются с таймингами
- Нажимает "Стоп"
- Запись сохраняется в память контроллера

**Функции:**

- Воспроизведение записи
- Экспорт в MIDI-файл
- Использование записи в режиме обучения

---

### 2.6 Режим разделения клавиатуры (Split)

**Описание:** Разные настройки для левой и правой части клавиатуры.

**Применение:**

- Разные цвета для левой и правой руки
- Обучение с фокусом на одну руку

**Настройки:**

| Параметр                 | Тип       | Описание                                           |
| -------------------------------- | ------------ | ---------------------------------------------------------- |
| Точка разделения  | Note picker  | Нота, где происходит разделение |
| Цвет левой части   | Color picker | —                                                         |
| Цвет правой части | Color picker | —                                                         |

---

### 2.7 Режим динамики (Velocity)

**Описание:** Цвет подсветки зависит от силы нажатия клавиши (velocity).

**Поведение:**

- Слабое нажатие — холодные цвета (синий, голубой)
- Среднее нажатие — нейтральные цвета (зелёный, жёлтый)
- Сильное нажатие — тёплые цвета (оранжевый, красный)

**Настройки:**

| Параметр | Тип | Описание |
|----------|-----|----------|
| Цветовая схема | Select | Градиент от синего к красному / от зелёного к красному / пользовательский |
| Яркость | Slider | Общая яркость |
| Время затухания | Slider | Как быстро гаснет LED после отпускания |

---

### 2.8 Режим случайных цветов (Random)

**Описание:** Каждая клавиша получает случайный цвет при нажатии.

**Поведение:**

- При нажатии клавиши генерируется случайный цвет
- Цвет сохраняется пока клавиша нажата
- При повторном нажатии — новый случайный цвет

**Настройки:**

| Параметр | Тип | Описание |
|----------|-----|----------|
| Насыщенность | Slider | Насыщенность случайных цветов |
| Яркость | Slider | Общая яркость |
| Время затухания | Slider | Как быстро гаснет LED после отпускания |

---

### 2.10 Режим игры/развлечения (Game)

**Описание:** Геймификация обучения.

**Варианты:**

- "Guitar Hero" стиль — ноты "падают" по ленте к клавишам
- Очки за точность и тайминг
- Комбо-множитель
- Таблица рекордов

**Настройки:**

| Параметр | Тип | Описание |
|----------|-----|----------|
| Сложность | Select | Easy / Medium / Hard |
| Скорость падения | Slider | Как быстро падают ноты |
| Показывать очки | Toggle | Отображение счёта |

---

### 2.11 Режим подсветки (Ambient)

**Описание:** Декоративная подсветка без привязки к игре.

**Эффекты:**

- Статичный цвет
- Плавный градиент
- Бегущая радуга
- Пульсация
- Дыхание (плавное изменение яркости)
- Волна (бегущая по ленте)
- Реакция на внешний звук (если добавить микрофон — будущее)

**Настройки:**

| Параметр | Тип | Описание |
|----------|-----|----------|
| Эффект | Select | Выбор эффекта |
| Основной цвет | Color picker | Для статичных эффектов |
| Скорость | Slider | Скорость анимации |
| Яркость | Slider | Общая яркость |

---

### 2.12 Режим Synthesia (внешнее ПО)

**Описание:** Интеграция с внешними обучающими программами (Synthesia и аналоги).

**Как работает:**

- Synthesia отправляет MIDI-команды на "световое пианино"
- Контроллер принимает эти команды и подсвечивает нужные клавиши
- Синхронизация с падающими нотами на экране

**Настройки:**

| Параметр | Тип | Описание |
|----------|-----|----------|
| MIDI канал | Select | Канал для приёма команд от Synthesia |
| Цвет левой руки | Color picker | — |
| Цвет правой руки | Color picker | — |

---

### 2.13 Режим Falling Notes (Падающие ноты)

**Описание:** Визуализация нот, падающих по LED-ленте к клавишам (как в Synthesia, но на самой ленте).

**Как работает:**

- При воспроизведении MIDI ноты "падают" сверху вниз по ленте
- Достигая нижнего края — момент нажатия клавиши
- В режиме обучения пользователь должен нажать в нужный момент

**Настройки:**

| Параметр | Тип | Описание |
|----------|-----|----------|
| Высота падения | Slider | Сколько LED используется для падения |
| Скорость | Slider | Скорость падения |
| Цвет | Color picker | Цвет падающих нот |

---

## 3. Приложение (PWA)

### 3.1 Структура экранов

```
┌─────────────────────────────────────┐
│              Pianora                │
├─────────────────────────────────────┤
│                                     │
│  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐   │
│  │Play │ │Learn│ │Lib  │ │Setup│   │
│  └─────┘ └─────┘ └─────┘ └─────┘   │
│                                     │
│         [Основной контент]          │
│                                     │
└─────────────────────────────────────┘
```

### 3.2 Экраны приложения

**Главный экран (Play)**

- Выбор режима (визуализация, свободная игра, и т.д.)
- Быстрые настройки текущего режима
- Индикатор подключения

**Обучение (Learn)**

- Выбор композиции
- Выбор сложности / руки
- Прогресс обучения
- Настройки режима обучения
- **Нотный стан** — отображение нот с синхронизацией текущей позиции

**Библиотека (Library)**

- Список композиций
- Импорт MIDI-файлов
- Мои записи
- Категории / поиск

**Настройки (Settings)**

- Настройки контроллера (WiFi, LED, система)
- Настройки приложения (тема, язык)
- Калибровка
- О приложении

### 3.3 Статус подключения

В приложении всегда отображается:

- Статус WiFi соединения с контроллером
- Статус MIDI устройства
- Текущий режим работы

### 3.4 Нотный стан (Sheet Music View)

**Описание:** Отображение нотной записи с синхронизацией текущей позиции воспроизведения.

**Функции:**

- Рендеринг нот из MIDI-файла
- Подсветка текущей позиции (вертикальная линия или выделение нот)
- Автопрокрутка при воспроизведении
- Отображение левой и правой руки разными цветами
- Масштабирование (zoom)

**Режимы отображения:**

| Режим | Описание |
|-------|----------|
| Скрипичный + басовый ключ | Стандартный вид для фортепиано |
| Только скрипичный | Для простых мелодий |
| Только басовый | Для басовых партий |

**Технология:** Использование библиотеки VexFlow или OpenSheetMusicDisplay для рендеринга нот в браузере.

**Синхронизация:**

- При воспроизведении — автоматическое следование за позицией
- В режиме обучения — подсветка текущей и следующих нот
- При записи — отображение записанных нот в реальном времени

---

## 4. Библиотека композиций

### 4.1 Источники

- Встроенные демо-композиции
- Импорт MIDI-файлов пользователем
- Записи пользователя

### 4.2 Формат хранения

```
/songs/
  ├── built-in/
  │   ├── fur-elise.mid
  │   └── ...
  ├── imported/
  │   └── ...
  └── recordings/
      └── ...
```

### 4.3 Метаданные композиции

- Название
- Автор/композитор
- Сложность
- Длительность
- Теги / категория

---

## 5. Протокол WebSocket

### 5.1 Формат сообщений

```json
{
  "type": "message_type",
  "payload": { }
}
```

### 5.2 Типы сообщений

**От контроллера к приложению:**

| Тип               | Описание                                   |
| -------------------- | -------------------------------------------------- |
| `midi_note`        | Нажатие/отпускание клавиши |
| `status`           | Статус контроллера                |
| `calibration_step` | Шаг калибровки                        |
| `recording_data`   | Данные записи                          |

**От приложения к контроллеру:**

| Тип                | Описание                                |
| --------------------- | ----------------------------------------------- |
| `set_mode`          | Сменить режим работы          |
| `set_settings`      | Изменить настройки             |
| `start_calibration` | Начать калибровку               |
| `play_song`         | Воспроизвести композицию |
| `start_recording`   | Начать запись                       |
| `stop_recording`    | Остановить запись               |

---

## 6. OTA обновления и варианты сборки

### 6.1 OTA обновления (ElegantOTA)

Контроллер поддерживает беспроводное обновление прошивки через ElegantOTA.

**Как использовать:**

1. Откройте `http://pianora.local/update` (или `http://192.168.4.1/update` в режиме AP)
2. Загрузите скомпилированный бинарный файл прошивки
3. Дождитесь перезагрузки контроллера

**Безопасность:**

- OTA доступен только в локальной сети
- Возможно отключение OTA через флаг компиляции

### 6.2 Варианты сборки прошивки

| Сборка | Описание | Flash | Функции |
|--------|----------|-------|---------|
| **esp32-s3** | Полная версия для ESP32-S3 | 16MB | USB MIDI, BLE MIDI, rtpMIDI, OTA |
| **esp32-s3-barebones** | Минимальная версия | 4MB | USB MIDI, базовые режимы |
| **esp32** | Для обычных ESP32 | 4MB | BLE MIDI, rtpMIDI (без USB MIDI) |

**Флаги компиляции (config.h):**

```cpp
#define USE_ELEGANT_OTA     1   // OTA обновления
#define USE_BLE_MIDI        1   // Bluetooth MIDI
#define USE_RTP_MIDI        1   // WiFi MIDI (rtpMIDI)
```

---

## 7. TODO / Открытые вопросы

- [ ] Определить комбинации горячих клавиш на пианино
- [ ] Продумать UX калибровки подробнее
- [ ] Формат хранения настроек
- [ ] API для управления файлами
- [x] ~~Нужен ли режим Game?~~ — Да, запланирован
- [x] ~~Нужен ли Ambient режим?~~ — Да, реализован
- [x] ~~BLE MIDI~~ — Реализовано
- [x] ~~rtpMIDI (WiFi MIDI)~~ — Реализовано
- [x] ~~OTA обновления~~ — Реализовано через ElegantOTA

---

## 8. Приоритеты реализации

### MVP (Minimum Viable Product)

1. Подключение и калибровка (быстрая)
2. Режим визуализации (базовый)
3. Режим свободной игры
4. Базовое приложение с настройками

### Версия 1.0

5. Режим обучения
6. Библиотека композиций
7. Импорт MIDI
8. Нотный стан (базовый)

### Версия 1.5

9. Режим записи
10. Режим разделения клавиатуры
11. Расширенные эффекты визуализации
12. Точная калибровка

### Версия 2.0

13. Режим Game
14. Ambient режимы
15. Режим Synthesia
16. Falling Notes

### Будущее

17. Синхронизация с облаком
18. Социальные функции (делиться записями)
19. Расширенная статистика обучения

---

## 9. Референсы

### Piano-LED-Visualizer

**URL:** [github.com/onlaj/Piano-LED-Visualizer](https://github.com/onlaj/Piano-LED-Visualizer)

**Платформа:** Raspberry Pi (Python + JavaScript)

**Полезные идеи:**

- Режим Synthesia
- Последовательности эффектов
- Структура веб-интерфейса
- Работа с MIDI-файлами

**Почему не форк:**

- Raspberry Pi требует больше места и энергии
- Python не оптимален для realtime LED
- ESP32-S3 компактнее и дешевле
- Возможность USB Host напрямую (без адаптеров)
- Нужна полная переработка архитектуры

---

### PianoLux-ESP32

**URL:** [github.com/serifpersia/pianolux-esp32](https://github.com/serifpersia/pianolux-esp32)

**Платформа:** ESP32 (Arduino IDE)

**Заимствованные идеи:**

- ElegantOTA для беспроводных обновлений
- BLE MIDI с библиотекой ESP32-BLE-MIDI
- rtpMIDI с библиотеками AppleMIDI
- Режимы Split, Velocity, Random
- Варианты сборки (barebones)

**Отличия Pianora:**

- PlatformIO вместо Arduino IDE
- Angular 19 PWA вместо встроенного веб-интерфейса
- TypeScript с signals вместо vanilla JS
- Более продвинутая архитектура приложения
- Режим обучения с нотным станом (VexFlow)
