# –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π Pianolux-ESP32 –∏ Pianora

–ê–Ω–∞–ª–∏–∑ —Ñ—É–Ω–∫—Ü–∏–π –∏–∑ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è pianolux-esp32, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ Pianora.

---

## –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è

### üî¥ –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

#### 1. –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –≥–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
**–í Pianolux:** –ü–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä –≥–æ—Ä—è—á–∏—Ö –∫–ª–∞–≤–∏—à –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–µ–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
**–í Pianora:** –¢–æ–ª—å–∫–æ 3 –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ (Point/Splash mode, 7 —Ü–≤–µ—Ç–æ–≤)

**–î–æ–±–∞–≤–∏—Ç—å:**
- `A1+B1 + E3` ‚Äî –£–≤–µ–ª–∏—á–∏—Ç—å —è—Ä–∫–æ—Å—Ç—å (+25)
- `A1+B1 + F3` ‚Äî –£–º–µ–Ω—å—à–∏—Ç—å —è—Ä–∫–æ—Å—Ç—å (-25)
- `A1+B1 + G3` ‚Äî –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º (Free ‚Üí Velocity ‚Üí Split ‚Üí Random)
- `A1+B1 + A3` ‚Äî –í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –ª–µ–Ω—Ç—É

#### 2. Hue Shift Mode (–†–µ–∂–∏–º —Å–º–µ—â–µ–Ω–∏—è —Ü–≤–µ—Ç–∞)
**–í Pianolux:** –ö–∞–∂–¥–∞—è –Ω–æ–≤–∞—è –Ω–æ—Ç–∞ –≤ –∞–∫–∫–æ—Ä–¥–µ –ø–æ–ª—É—á–∞–µ—Ç –¥—Ä—É–≥–æ–π –æ—Ç—Ç–µ–Ω–æ–∫ (hue +10)
**–í Pianora:** –ù–µ—Ç

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```cpp
// –ï—Å–ª–∏ –Ω–æ—Ç–∞ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 600–º—Å –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–π
if (now - lastNoteTime < 600) {
  chordHue += 10; // –°–º–µ—â–∞–µ–º —Ü–≤–µ—Ç
} else {
  chordHue = baseHue; // –ù–æ–≤—ã–π –∞–∫–∫–æ—Ä–¥ - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º
}
```

#### 3. Background Layer (–§–æ–Ω–æ–≤—ã–π —Å–ª–æ–π)
**–í Pianolux:** –û—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–æ–Ω–æ–≤—ã–π —Ü–≤–µ—Ç, –∫–æ—Ç–æ—Ä—ã–π –≤–∏–¥–µ–Ω –∫–æ–≥–¥–∞ –∫–ª–∞–≤–∏—à–∏ –Ω–µ –Ω–∞–∂–∞—Ç—ã
**–í Pianora:** –õ–µ–Ω—Ç–∞ –≥–∞—Å–Ω–µ—Ç –ø—Ä–∏ –æ—Ç–ø—É—Å–∫–∞–Ω–∏–∏

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `bgBrightness` ‚Äî –Ø—Ä–∫–æ—Å—Ç—å —Ñ–æ–Ω–∞ (0-255)
- `bgColor` ‚Äî –¶–≤–µ—Ç —Ñ–æ–Ω–∞ (HSV)
- `bgEnabled` ‚Äî –í–∫–ª/–≤—ã–∫–ª

#### 4. Guide Color (–¶–≤–µ—Ç –ø–æ–¥—Å–∫–∞–∑–∫–∏)
**–í Pianolux:** LED –ø–ª–∞–≤–Ω–æ –∑–∞—Ç—É—Ö–∞–µ—Ç –∫ —Ü–≤–µ—Ç—É –ø–æ–¥—Å–∫–∞–∑–∫–∏ –≤–º–µ—Å—Ç–æ —á—ë—Ä–Ω–æ–≥–æ
**–í Pianora:** –ù–µ—Ç (–≤–∞–∂–Ω–æ –¥–ª—è —Ä–µ–∂–∏–º–∞ –æ–±—É—á–µ–Ω–∏—è!)

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:** –í —Ä–µ–∂–∏–º–µ Learning –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ–∂–∏–¥–∞–µ–º—ã–µ –∫–ª–∞–≤–∏—à–∏ –æ–¥–Ω–∏–º —Ü–≤–µ—Ç–æ–º, –∞ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ ‚Äî –¥—Ä—É–≥–∏–º.

---

### üü° –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

#### 5. –ê–Ω–∏–º–∞—Ü–∏–∏ Ambient (10 —ç—Ñ—Ñ–µ–∫—Ç–æ–≤)
**–í Pianolux:**
- Rainbow ‚Äî –†–∞–¥—É–≥–∞
- Ocean ‚Äî –û–∫–µ–∞–Ω–∏—á–µ—Å–∫–∏–µ —Ü–≤–µ—Ç–∞
- Cloud ‚Äî –û–±–ª–∞—á–Ω—ã–µ –ø–µ—Ä–µ–ª–∏–≤—ã
- Lava ‚Äî –õ–∞–≤–æ–≤—ã–µ —Ü–≤–µ—Ç–∞
- Forest ‚Äî –õ–µ—Å–Ω—ã–µ —Ç–æ–Ω–∞
- Party ‚Äî –í–µ—á–µ—Ä–∏–Ω–æ—á–Ω—ã–µ —Ü–≤–µ—Ç–∞
- Sine Wave ‚Äî –°–∏–Ω—É—Å–æ–∏–¥–∞–ª—å–Ω–∞—è –≤–æ–ª–Ω–∞
- Sparkle ‚Äî –ò—Å–∫—Ä—ã
- Snake ‚Äî –ó–º–µ–π–∫–∞

**–í Pianora:** –¢–æ–ª—å–∫–æ –∑–∞–≥–ª—É—à–∫–∞ MODE_AMBIENT

#### 6. Chord Detection (–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∞–∫–∫–æ—Ä–¥–æ–≤)
**–í Pianolux:** –ù–æ—Ç—ã –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 600–º—Å –ø–æ–ª—É—á–∞—é—Ç –æ–¥–∏–Ω —Ü–≤–µ—Ç
**–í Pianora:** –ö–∞–∂–¥–∞—è –Ω–æ—Ç–∞ –Ω–µ–∑–∞–≤–∏—Å–∏–º–∞

**–ü–æ–ª—å–∑–∞:** –í–∏–∑—É–∞–ª—å–Ω–æ –≤—ã–¥–µ–ª—è–µ—Ç –≥–∞—Ä–º–æ–Ω–∏—á–µ—Å–∫—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É

#### 7. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –ø—Ä–µ—Å–µ—Ç—ã —Ü–≤–µ—Ç–æ–≤
**–í Pianolux:** 7+ –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤—ã—Ö —Å—Ö–µ–º
**–í Pianora:** –¢–æ–ª—å–∫–æ —Ä—É—á–Ω–æ–π –≤—ã–±–æ—Ä

**–î–æ–±–∞–≤–∏—Ç—å –≤ UI:**
- Preset 1: –¢—ë–ø–ª—ã–µ —Ç–æ–Ω–∞ (–∫—Ä–∞—Å–Ω—ã–π‚Üí–∂—ë–ª—Ç—ã–π)
- Preset 2: –•–æ–ª–æ–¥–Ω—ã–µ —Ç–æ–Ω–∞ (—Å–∏–Ω–∏–π‚Üí—Ü–∏–∞–Ω)
- Preset 3: –†–∞–¥—É–≥–∞
- Preset 4: –ú–æ–Ω–æ—Ö—Ä–æ–º

---

### üü¢ –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–¥–ª—è –±—É–¥—É—â–∏—Ö –≤–µ—Ä—Å–∏–π)

#### 8. IP-–∞–¥—Ä–µ—Å –Ω–∞ –ª–µ–Ω—Ç–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
**–í Pianolux:** –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ LED –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç IP-–∞–¥—Ä–µ—Å —Ç–æ—á–∫–∞–º–∏

#### 9. –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Split Mode
**–í Pianolux:**
- –ü–æ–∑–∏—Ü–∏—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è (0-100%)
- –ù–µ–∑–∞–≤–∏—Å–∏–º—ã–µ —Ü–≤–µ—Ç–∞ (H, S, V) –¥–ª—è –∫–∞–∂–¥–æ–π –∑–æ–Ω—ã

**–í Pianora:** –ï—Å—Ç—å –≤ –ø—Ä–æ—à–∏–≤–∫–µ, –Ω–µ—Ç UI

#### 10. –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ velocity
**–í Pianolux:** Weighted average –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —è—Ä–∫–æ—Å—Ç–∏
**–í Pianora:** –ü—Ä—è–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ velocity

```cpp
smoothedVelocity = (prevVelocity * 0.3 + newVelocity * 0.7);
```

---

## –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞

| –§—É–Ω–∫—Ü–∏—è | Pianolux | Pianora | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è |
|---------|----------|---------|--------------|
| USB MIDI | ‚úÖ | ‚úÖ | ‚Äî |
| BLE MIDI | ‚úÖ | ‚úÖ | ‚Äî |
| RTP MIDI | ‚úÖ | ‚ùå | –ù–µ –Ω—É–∂–Ω–æ |
| –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ (–ø–æ–ª–Ω—ã–µ) | ‚úÖ | ‚ö†Ô∏è | **–î–æ–±–∞–≤–∏—Ç—å** |
| Free Play | ‚úÖ | ‚úÖ | ‚Äî |
| Velocity Mode | ‚úÖ | ‚úÖ | ‚Äî |
| Split Mode | ‚úÖ | ‚úÖ | –î–æ–±–∞–≤–∏—Ç—å UI |
| Random Mode | ‚úÖ | ‚úÖ | ‚Äî |
| Splash Effect | ‚úÖ | ‚úÖ | ‚Äî |
| Hue Shift (–∞–∫–∫–æ—Ä–¥—ã) | ‚úÖ | ‚ùå | **–î–æ–±–∞–≤–∏—Ç—å** |
| Background Layer | ‚úÖ | ‚ùå | **–î–æ–±–∞–≤–∏—Ç—å** |
| Guide Color | ‚úÖ | ‚ùå | **–î–æ–±–∞–≤–∏—Ç—å** |
| Ambient –∞–Ω–∏–º–∞—Ü–∏–∏ | ‚úÖ (10) | ‚ùå | –î–æ–±–∞–≤–∏—Ç—å |
| Chord Detection | ‚úÖ | ‚ùå | –î–æ–±–∞–≤–∏—Ç—å |
| –¶–≤–µ—Ç–æ–≤—ã–µ –ø—Ä–µ—Å–µ—Ç—ã | ‚úÖ | ‚ùå | –î–æ–±–∞–≤–∏—Ç—å |
| –Ø—Ä–∫–æ—Å—Ç—å —á–µ—Ä–µ–∑ –≥–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ | ‚úÖ | ‚ùå | **–î–æ–±–∞–≤–∏—Ç—å** |
| IP –Ω–∞ –ª–µ–Ω—Ç–µ | ‚úÖ | ‚ùå | –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ |
| OTA Updates | ‚úÖ | ‚úÖ | ‚Äî |
| WebSocket | ‚úÖ | ‚úÖ | ‚Äî |
| MIDI —Ñ–∞–π–ª—ã | ‚úÖ | ‚úÖ | ‚Äî |

---

## –ü–ª–∞–Ω –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### –≠—Ç–∞–ø 1: –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ –∏ –±–∞–∑–æ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
1. –î–æ–±–∞–≤–∏—Ç—å –≥–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ –¥–ª—è —è—Ä–∫–æ—Å—Ç–∏ (+/-)
2. –î–æ–±–∞–≤–∏—Ç—å –≥–æ—Ä—è—á—É—é –∫–ª–∞–≤–∏—à—É –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–æ–≤
3. –î–æ–±–∞–≤–∏—Ç—å –≥–æ—Ä—è—á—É—é –∫–ª–∞–≤–∏—à—É –≤–∫–ª/–≤—ã–∫–ª

### –≠—Ç–∞–ø 2: –í–∏–∑—É–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
4. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Background Layer
5. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Guide Color –¥–ª—è —Ä–µ–∂–∏–º–∞ –æ–±—É—á–µ–Ω–∏—è
6. –î–æ–±–∞–≤–∏—Ç—å Hue Shift –¥–ª—è –∞–∫–∫–æ—Ä–¥–æ–≤

### –≠—Ç–∞–ø 3: UI –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π
7. –î–æ–±–∞–≤–∏—Ç—å UI –¥–ª—è Split Mode
8. –î–æ–±–∞–≤–∏—Ç—å UI –¥–ª—è Velocity Mode
9. –î–æ–±–∞–≤–∏—Ç—å —Ü–≤–µ—Ç–æ–≤—ã–µ –ø—Ä–µ—Å–µ—Ç—ã

### –≠—Ç–∞–ø 4: Ambient —Ä–µ–∂–∏–º—ã
10. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Rainbow animation
11. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Sine Wave
12. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Sparkle

---

## –ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞ –∏–∑ Pianolux

### Background Layer
```cpp
// FadeController.ino
void fadeToColor(CRGB* ledArray, int ledCount, CRGB targetColor, uint8_t fadeRate) {
  for (int i = 0; i < ledCount; i++) {
    ledArray[i] = nblend(ledArray[i], targetColor, fadeRate);
  }
}
```

### Guide Color
```cpp
if (guideModeOn) {
  targetColor = guideColor;
} else if (bgModeOn) {
  targetColor = bgColor;
} else {
  targetColor = CRGB::Black;
}
```

### Chord Detection
```cpp
#define CHORD_WINDOW_MS 600
if (millis() - lastNoteTime < CHORD_WINDOW_MS) {
  // Same chord - increment hue
  currentChordHue = (currentChordHue + 10) % 256;
} else {
  // New chord
  currentChordHue = baseHue;
}
lastNoteTime = millis();
```

### Smoothed Velocity
```cpp
float smoothVelocity(uint8_t newVel, float prevVel) {
  return prevVel * 0.3f + (float)newVel * 0.7f;
}
```
