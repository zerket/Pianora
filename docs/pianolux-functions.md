# PianoLux ESP32 - Список функций приложения

## Обзор проекта

PianoLux - это система LED-визуализации для MIDI-устройств на базе ESP32. Приложение принимает MIDI-сигналы из нескольких источников и преобразует их в световые эффекты на WS2812B LED-ленте.

**Платформы**: ESP32-S3, ESP32-S2, ESP32
**Максимум LED**: 176 (для 88-клавишного пианино)
**Версия прошивки**: v1.12

---

## 1. LED Режимы (8 режимов)

| Режим | ID | Описание |
|-------|-----|----------|
| **Default** | 0 | Простая подсветка нажатых клавиш одним цветом HSB |
| **Splash** | 1 | Волновой эффект от нажатой ноты в обе стороны |
| **Random** | 2 | Случайный цвет для каждой ноты с детекцией аккордов |
| **Velocity** | 3 | Цвет зависит от силы нажатия (velocity) |
| **Animation** | 4 | Статические анимации без привязки к MIDI |
| **Split** | 5 | Двухцветное разделение клавиатуры |
| **Background** | - | Фоновая подсветка (дополнительный слой) |
| **Guide** | - | Режим подсказок для обучения |

### Детали режимов

#### Default Mode (0)
- HSV-цвет настраивается через Web UI
- Мгновенное включение при Note On
- Fade-затухание при Note Off

#### Splash Mode (1)
- Волна распространяется влево и вправо от ноты
- Длина волны: настраиваемая (splashMaxLength, до 8 LED)
- Яркость волны зависит от velocity
- Скорость затухания: headFadeRate (по умолчанию 5)

#### Random Mode (2)
- Случайный hue для каждой ноты
- Детекция аккордов: ноты в пределах 600мс получают одинаковый цвет
- Близкие ноты (50мс): небольшое смещение hue (+10)

#### Velocity Mode (3)
- Velocity 16-80 → Hue 75-255
- Velocity 16-80 → Brightness 65-255
- Сглаживание velocity через IIR-фильтр

#### Animation Mode (4)
- 10 встроенных анимаций
- MIDI-вход игнорируется

#### Split Mode (5)
- Позиция разделения: 0-100%
- Отдельные цвета для левой и правой части
- По умолчанию: красный/синий

---

## 2. Анимации (10 анимаций)

| ID | Название | Описание |
|----|----------|----------|
| 0 | Rainbow | Радужная палитра |
| 1 | Ocean | Океанские оттенки |
| 2 | Cloud | Облачные тона |
| 3 | Lava | Лавовые цвета |
| 4 | Forest | Лесные оттенки |
| 5 | Party | Яркие вечериночные цвета |
| 6 | Heat | Тепловая палитра |
| 7 | Sine Wave | Синусоидальная волна |
| 8 | Sparkle Dots | Мерцающие точки |
| 9 | Snake | Игра "Змейка" |

---

## 3. Источники MIDI

### USB MIDI (только ESP32-S3/S2)
- Прямое подключение через USB Host OTG
- GPIO19/20 для USB данных
- Асинхронная очередь сообщений
- Поддержка всех USB MIDI устройств

### Bluetooth MIDI (ESP32-S3/ESP32)
- BLE MIDI профиль
- Автоподключение к первому найденному устройству
- Поддержка Note On/Off, Control Change
- Пересылка на RTP MIDI

### WiFi MIDI (все платы)
- Протокол AppleMIDI/rtpMIDI
- Порт: 5004
- Управление сессиями
- Двунаправленный MIDI

---

## 4. WebSocket API

**Подключение**: `ws://device-ip:81`

### Формат сообщений
```json
{
  "action": "CommandName",
  "mode": 0,
  "value": 255
}
```

### Команды управления LED

| Команда | Параметры | Описание |
|---------|-----------|----------|
| `ChangeLEDModeAction` | mode (0-5) | Переключение режима LED |
| `ChangeAnimationAction` | value (0-9) | Выбор анимации |
| `Hue` | value (0-255) | Установка оттенка |
| `Saturation` | value (0-255) | Установка насыщенности |
| `Brightness` | value (0-255) | Установка яркости |
| `Fade` | value (0-255) | Длительность затухания |
| `Splash` | value (0-255) | Максимальная длина splash-эффекта |
| `Background` | value (0-255) | Яркость фона |
| `BGAction` | value (0/1) | Вкл/выкл фоновой подсветки |
| `BGUpdateAction` | - | Применить HSV к фону |
| `DirectionAction` | value (0/1) | Реверс направления LED |
| `FixAction` | value (0/1) | Коррекция смещения LED |
| `Split` | value (0-100) | Позиция разделения (Split Mode) |
| `SetSplitAction` | leftH, leftS, leftV, rightH, rightS, rightV | Цвета для Split Mode |

### Команды настройки платы

| Команда | Параметры | Описание |
|---------|-----------|----------|
| `CurrentAction` | value (0-1000) | Лимит тока в мА |
| `LedDataPinAction` | value | Номер GPIO для LED |
| `ChangeColorOrderAction` | value (0-2) | Порядок цветов: GRB/RGB/BRG |
| `ColorPresetAction` | value | Применить пресет цвета |
| `ChangeWifiModeAction` | value (0-2) | Режим WiFi: STA/Portal/AP |
| `ChangeClientLoggerAction` | value (0/1) | Вкл/выкл логирование |
| `PianoSizeAction` | value | Размер пианино (49-88 клавиш) |
| `LedScaleRatioAction` | value | Соотношение MIDI:LED |

### Команды MIDI плеера

| Команда | Параметры | Описание |
|---------|-----------|----------|
| `playMidi` | filename | Запустить воспроизведение |
| `stopMidi` | - | Остановить воспроизведение |
| `pauseMidi` | - | Пауза |
| `resumeMidi` | - | Продолжить воспроизведение |
| `deleteFile` | filename | Удалить MIDI файл |
| `getStatus` | - | Запросить текущий статус |

### Системные команды

| Команда | Описание |
|---------|----------|
| `ScanBluetoothAction` | Сканировать BLE MIDI устройства |
| `ReadESP32Info` | Получить информацию о плате |
| `ReadESP32Logs` | Получить логи |
| `RequestValues` | Запросить все текущие настройки |

---

## 5. REST API

| Endpoint | Метод | Описание |
|----------|-------|----------|
| `/` | GET | Веб-интерфейс (index.html) |
| `/api/storage` | GET | Информация о хранилище (total, used, free) |
| `/api/files` | GET | JSON список MIDI файлов |
| `/api/upload` | POST | Загрузка файла (макс. 1MB) |

---

## 6. Система конфигурации

### Файл конфигурации
**Путь**: `/config.cfg` (LittleFS, JSON формат)

### Параметры
```json
{
  "LED_PIN": 18,
  "COLOR_ORDER": 0,
  "LED_CURRENT": 450,
  "WIFI_MODE": 0,
  "CLIENT_LOGGER": 0
}
```

### Режимы WiFi
| Значение | Режим | Описание |
|----------|-------|----------|
| 0 | STA | Подключение к существующей сети |
| 1 | Portal | Captive portal для настройки |
| 2 | AP | Точка доступа "PianoLux AP" |

### Размеры пианино
| Клавиши | LED | Диапазон нот |
|---------|-----|--------------|
| 88 | 176 | A0-C8 |
| 76 | 152 | F1-G6 |
| 73 | 146 | F1-D6 |
| 61 | 122 | C2-C7 |
| 49 | 98 | C2-C7 |

---

## 7. Глобальные настройки LED

| Параметр | Диапазон | По умолчанию | Описание |
|----------|----------|--------------|----------|
| Hue | 0-255 | - | Оттенок цвета |
| Saturation | 0-255 | 255 | Насыщенность |
| Brightness | 0-255 | 255 | Яркость |
| Fade Length | 0-255 | - | Длительность затухания |
| Fade Rate | 0-255 | 50 | Скорость затухания |
| Splash Max Length | 0-255 | 8 | Макс. длина splash-эффекта |
| Head Fade Rate | - | 5 | Затухание головы splash |
| Max Current | 0-1000 | 450 | Лимит тока (мА) |

---

## 8. Структура файлов

```
pianolux-esp32/
├── ESP32_PianoLux/
│   ├── ESP32_PianoLux.ino    # Главный файл, инициализация, loop
│   ├── Animation.ino          # 10 LED анимаций
│   ├── BLEMidi.ino           # Bluetooth MIDI обработка
│   ├── USBMidi.ino           # USB Host MIDI
│   ├── MidiParser.ino        # Парсинг USB MIDI пакетов
│   ├── WebServer.ino         # WebSocket и HTTP сервер
│   ├── FadeController.h/ino  # Эффект затухания
│   ├── FadingRunEffect.h/ino # Splash-эффект
│   ├── usbhhelp.hpp          # Хелперы USB Host
│   ├── w2812-rmt.hpp         # RMT драйвер для WS2812B
│   ├── partitions.csv        # Таблица разделов
│   └── data/                 # Веб-ассеты и MIDI файлы
├── ESP32_PianoLux_Barebones/ # Облегченная версия для OTA
├── install_libs.bat/sh       # Установка библиотек
└── README.md
```

---

## 9. Технические характеристики

| Параметр | Значение |
|----------|----------|
| Частота обновления LED | 60 FPS |
| Интервал эффектов | 20 мс |
| Макс. одновременных эффектов | 128 |
| Размер MIDI очереди | 16 сообщений |
| Макс. размер MIDI файла | 1 MB |
| mDNS hostname | pianolux.local |
| HTTP порт | 80 |
| WebSocket порт | 81 |
| RTP MIDI порт | 5004 |

---

## 10. Уникальные возможности

1. **Мульти-источник MIDI** - одновременная работа USB + BLE + WiFi
2. **Детекция аккордов** - группировка нот в пределах 600мс
3. **Velocity-зависимые эффекты** - яркость и цвет от силы нажатия
4. **Двунаправленный Splash** - волна от ноты в обе стороны
5. **MIDI файл плеер** - воспроизведение с паузой/продолжением
6. **OTA обновления** - прошивка и файловая система без кабеля
7. **IP через LED** - отображение IP адреса на ленте
8. **Персистентная конфигурация** - сохранение в LittleFS
9. **WebSocket логирование** - мониторинг событий в реальном времени
10. **Настраиваемое маппирование** - поддержка пианино разных размеров
