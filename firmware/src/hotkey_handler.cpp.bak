#include "hotkey_handler.h"
#include "led_controller.h"

// Global pointer - initialized in setup() to avoid static initialization issues
HotkeyHandler* hotkeyHandler = nullptr;

HotkeyHandler::HotkeyHandler() : _pressedCount(0) {
    memset(_pressedNotes, 0, sizeof(_pressedNotes));
    memset(_pressedTimes, 0, sizeof(_pressedTimes));
}

void HotkeyHandler::noteOn(uint8_t note, uint8_t velocity) {
    // Check if already in list
    for (uint8_t i = 0; i < _pressedCount; i++) {
        if (_pressedNotes[i] == note) {
            return;  // Already pressed
        }
    }

    // Add to pressed list
    if (_pressedCount < MAX_PRESSED) {
        _pressedNotes[_pressedCount] = note;
        _pressedTimes[_pressedCount] = millis();
        _pressedCount++;
    }
}

void HotkeyHandler::noteOff(uint8_t note) {
    // Remove from pressed list
    for (uint8_t i = 0; i < _pressedCount; i++) {
        if (_pressedNotes[i] == note) {
            // Shift remaining notes
            for (uint8_t j = i; j < _pressedCount - 1; j++) {
                _pressedNotes[j] = _pressedNotes[j + 1];
                _pressedTimes[j] = _pressedTimes[j + 1];
            }
            _pressedCount--;
            break;
        }
    }
}

bool HotkeyHandler::isActivationNote(uint8_t note) {
    return (note == HOTKEY_A1 || note == HOTKEY_B1);
}

bool HotkeyHandler::isActivationPressed() {
    bool hasA1 = false, hasB1 = false;
    uint32_t now = millis();

    for (uint8_t i = 0; i < _pressedCount; i++) {
        // Check if key has been held long enough
        if (now - _pressedTimes[i] >= HOLD_TIME_MS) {
            if (_pressedNotes[i] == HOTKEY_A1) hasA1 = true;
            if (_pressedNotes[i] == HOTKEY_B1) hasB1 = true;
        }
    }

    return hasA1 && hasB1;
}

bool HotkeyHandler::checkHotkey() {
    if (!isActivationPressed()) return false;

    // Look for action key (any key that's not A1 or B1)
    for (uint8_t i = 0; i < _pressedCount; i++) {
        uint8_t note = _pressedNotes[i];

        if (note != HOTKEY_A1 && note != HOTKEY_B1) {
            executeHotkey(note);
            return true;
        }
    }
    return false;
}

uint8_t HotkeyHandler::getHueForNote(uint8_t note) {
    switch (note) {
        case HOTKEY_COLOR_C4: return HOTKEY_HUE_RED;
        case HOTKEY_COLOR_D4: return HOTKEY_HUE_ORANGE;
        case HOTKEY_COLOR_E4: return HOTKEY_HUE_YELLOW;
        case HOTKEY_COLOR_F4: return HOTKEY_HUE_GREEN;
        case HOTKEY_COLOR_G4: return HOTKEY_HUE_CYAN;
        case HOTKEY_COLOR_A4: return HOTKEY_HUE_BLUE;
        case HOTKEY_COLOR_B4: return HOTKEY_HUE_VIOLET;
        default: return 255;  // Invalid
    }
}

void HotkeyHandler::flashConfirmation() {
    ledController->showColor(CRGB::White);
    delay(100);
    ledController->blackout();
}

void HotkeyHandler::executeHotkey(uint8_t actionNote) {
    switch (actionNote) {
        case HOTKEY_POINT_MODE:
            // Point mode: disable splash
            ledController->setMode(MODE_FREE_PLAY);
            ledController->setSplashEnabled(false);
            flashConfirmation();
            break;

        case HOTKEY_SPLASH_MODE:
            // Splash mode: enable splash effect
            ledController->setMode(MODE_FREE_PLAY);
            ledController->setSplashEnabled(true);
            flashConfirmation();
            break;

        case HOTKEY_BRIGHTNESS_UP:
            // Increase brightness by 25
            ledController->adjustBrightness(25);
            flashConfirmation();
            break;

        case HOTKEY_BRIGHTNESS_DOWN:
            // Decrease brightness by 25
            ledController->adjustBrightness(-25);
            flashConfirmation();
            break;

        case HOTKEY_MODE_CYCLE:
            // Cycle through LED modes
            ledController->cycleMode();
            flashConfirmation();
            break;

        case HOTKEY_TOGGLE_LED:
            // Toggle LED on/off
            ledController->toggleEnabled();
            if (ledController->isEnabled()) {
                flashConfirmation();
            }
            break;

        case HOTKEY_PLAY_PAUSE:
            // Play/pause - notify app via WebSocket
            onHotkeyPlayPause();
            flashConfirmation();
            break;

        case HOTKEY_COLOR_C4:
        case HOTKEY_COLOR_D4:
        case HOTKEY_COLOR_E4:
        case HOTKEY_COLOR_F4:
        case HOTKEY_COLOR_G4:
        case HOTKEY_COLOR_A4:
        case HOTKEY_COLOR_B4:
            // Color change
            {
                uint8_t hue = getHueForNote(actionNote);
                if (hue != 255) {
                    ledController->setHue(hue);
                    // Show the new color briefly
                    ledController->showColor(CHSV(hue, 255, 255));
                    delay(150);
                    ledController->blackout();
                }
            }
            break;

        default:
            // Unknown action key - ignore
            break;
    }
}
